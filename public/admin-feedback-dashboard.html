<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة إدارة التعليقات والاقتراحات</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-top: 4px solid;
        }
        
        .stat-card.feedback { border-top-color: #3498db; }
        .stat-card.reviews { border-top-color: #f39c12; }
        .stat-card.suggestions { border-top-color: #9b59b6; }
        .stat-card.recent { border-top-color: #e74c3c; }
        
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .stat-card.feedback .stat-number { color: #3498db; }
        .stat-card.reviews .stat-number { color: #f39c12; }
        .stat-card.suggestions .stat-number { color: #9b59b6; }
        .stat-card.recent .stat-number { color: #e74c3c; }
        
        .stat-label {
            color: #6c757d;
            font-size: 14px;
        }
        
        .filters {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .filter-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .feedback-list {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .feedback-item {
            border-bottom: 1px solid #e9ecef;
            padding: 25px;
            transition: background-color 0.3s ease;
        }
        
        .feedback-item:hover {
            background: #f8f9fa;
        }
        
        .feedback-item:last-child {
            border-bottom: none;
        }
        
        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .feedback-meta {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .feedback-type {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        
        .type-feedback { background: #3498db; }
        .type-review { background: #f39c12; }
        .type-suggestion { background: #9b59b6; }
        .type-contact { background: #e74c3c; }
        
        .urgency {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .urgency-low { background: #d4edda; color: #155724; }
        .urgency-medium { background: #fff3cd; color: #856404; }
        .urgency-high { background: #f8d7da; color: #721c24; }
        .urgency-urgent { background: #721c24; color: white; }
        
        .feedback-content {
            margin-bottom: 15px;
        }
        
        .feedback-title {
            color: #2c3e50;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .feedback-text {
            color: #5a6c7d;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .feedback-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .action-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .action-btn:hover { background: #218838; }
        .action-btn.respond { background: #007bff; }
        .action-btn.respond:hover { background: #0056b3; }
        .action-btn.delete { background: #dc3545; }
        .action-btn.delete:hover { background: #c82333; }
        
        .rating-display {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
        }
        
        .rating-stars {
            color: #f39c12;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .refresh-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .refresh-btn:hover {
            background: #138496;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📋 لوحة إدارة التعليقات والاقتراحات</h1>
            <p>متابعة وإدارة جميع رسائل المستخدمين</p>
            <button onclick="refreshData()" class="refresh-btn" style="margin-top: 15px;">🔄 تحديث البيانات</button>
        </div>
        
        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card feedback">
                <div class="stat-number" id="totalFeedback">0</div>
                <div class="stat-label">إجمالي الرسائل</div>
            </div>
            <div class="stat-card reviews">
                <div class="stat-number" id="totalReviews">0</div>
                <div class="stat-label">التقييمات</div>
            </div>
            <div class="stat-card suggestions">
                <div class="stat-number" id="totalSuggestions">0</div>
                <div class="stat-label">الاقتراحات</div>
            </div>
            <div class="stat-card recent">
                <div class="stat-number" id="recentCount">0</div>
                <div class="stat-label">الأسبوع الماضي</div>
            </div>
            <div class="stat-card reviews">
                <div class="stat-number" id="averageRating">0</div>
                <div class="stat-label">متوسط التقييم</div>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="filters">
            <div class="filter-group">
                <select id="typeFilter" onchange="filterFeedback()">
                    <option value="">جميع الأنواع</option>
                    <option value="feedback">الرسائل</option>
                    <option value="review">التقييمات</option>
                    <option value="suggestion">الاقتراحات</option>
                    <option value="contact">التواصل السريع</option>
                </select>
                
                <select id="statusFilter" onchange="filterFeedback()">
                    <option value="">جميع الحالات</option>
                    <option value="new">جديد</option>
                    <option value="read">مقروء</option>
                    <option value="responded">تم الرد</option>
                    <option value="resolved">محلول</option>
                </select>
                
                <select id="urgencyFilter" onchange="filterFeedback()">
                    <option value="">جميع الأولويات</option>
                    <option value="urgent">عاجل</option>
                    <option value="high">عالي</option>
                    <option value="medium">متوسط</option>
                    <option value="low">منخفض</option>
                </select>
                
                <input type="date" id="dateFilter" onchange="filterFeedback()">
                
                <button onclick="clearFilters()" class="action-btn">🗑️ مسح الفلاتر</button>
            </div>
        </div>
        
        <!-- Feedback List -->
        <div class="feedback-list">
            <div id="feedbackListContent" class="loading">
                <div style="font-size: 24px; margin-bottom: 10px;">⏳</div>
                جاري تحميل التعليقات...
            </div>
        </div>
    </div>
    
    <script>
        let allFeedback = [];
        let filteredFeedback = [];
        
        async function loadFeedbackData() {
            try {
                // Load statistics
                const statsResponse = await fetch('/api/feedback-stats');
                if (statsResponse.ok) {
                    const statsData = await statsResponse.json();
                    updateStats(statsData.stats);
                }
                
                // Load recent feedback
                const feedbackResponse = await fetch('/api/recent-feedback?limit=50');
                if (feedbackResponse.ok) {
                    const feedbackData = await feedbackResponse.json();
                    allFeedback = feedbackData.feedback || [];
                    filteredFeedback = [...allFeedback];
                    displayFeedback();
                } else {
                    // Fallback to demo data
                    loadDemoFeedback();
                }
                
            } catch (error) {
                console.error('Error loading feedback:', error);
                loadDemoFeedback();
            }
        }
        
        function updateStats(stats) {
            document.getElementById('totalFeedback').textContent = stats.totalFeedback;
            document.getElementById('totalReviews').textContent = stats.totalReviews;
            document.getElementById('totalSuggestions').textContent = stats.totalSuggestions;
            document.getElementById('recentCount').textContent = stats.recentCount;
            document.getElementById('averageRating').textContent = stats.averageRating;
        }
        
        function loadDemoFeedback() {
            // Demo data for testing
            allFeedback = [
                {
                    id: '1',
                    type: 'feedback',
                    data: {
                        type: 'general',
                        userType: 'parent',
                        userName: 'أم محمد',
                        subject: 'النظام ممتاز',
                        message: 'النظام سهل الاستخدام ومفيد جداً في متابعة أداء أطفالي',
                        urgency: 'low'
                    },
                    timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
                    status: 'new'
                },
                {
                    id: '2',
                    type: 'suggestion',
                    data: {
                        category: 'mobile',
                        title: 'إضافة إشعارات للجوال',
                        description: 'أقترح إضافة إشعارات تنبيه عند إضافة درجات جديدة',
                        priority: 'high'
                    },
                    timestamp: new Date(Date.now() - 5 * 60 * 60 * 1000).toISOString(),
                    status: 'new'
                },
                {
                    id: '3',
                    type: 'review',
                    data: {
                        overallRating: 5,
                        reviewerName: 'معلم أحمد',
                        reviewText: 'النظام ساعدني كثيراً في إدارة الطلاب وتتبع أدائهم'
                    },
                    timestamp: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(),
                    status: 'read'
                }
            ];
            
            filteredFeedback = [...allFeedback];
            displayFeedback();
            
            // Demo stats
            updateStats({
                totalFeedback: 15,
                totalReviews: 8,
                totalSuggestions: 12,
                recentCount: 5,
                averageRating: 4.3
            });
        }
        
        function displayFeedback() {
            const container = document.getElementById('feedbackListContent');
            
            if (filteredFeedback.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 48px; margin-bottom: 20px;">📭</div>
                        <h3>لا توجد تعليقات</h3>
                        <p>لا توجد تعليقات تطابق الفلاتر المحددة</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredFeedback.map(item => {
                const typeEmoji = {
                    feedback: '📝',
                    review: '⭐',
                    suggestion: '💡',
                    contact: '📞'
                };
                
                const typeLabel = {
                    feedback: 'رسالة',
                    review: 'تقييم',
                    suggestion: 'اقتراح',
                    contact: 'تواصل'
                };
                
                const urgencyClass = `urgency-${item.data.urgency || 'medium'}`;
                const urgencyLabel = {
                    low: 'منخفض',
                    medium: 'متوسط', 
                    high: 'عالي',
                    urgent: 'عاجل'
                };
                
                const date = new Date(item.timestamp).toLocaleString('ar-EG');
                
                let ratingDisplay = '';
                if (item.type === 'review' && item.data.overallRating) {
                    const stars = '⭐'.repeat(item.data.overallRating);
                    ratingDisplay = `
                        <div class="rating-display">
                            <span class="rating-stars">${stars}</span>
                            <span>(${item.data.overallRating}/5)</span>
                        </div>
                    `;
                }
                
                return `
                    <div class="feedback-item">
                        <div class="feedback-header">
                            <div class="feedback-meta">
                                <span class="feedback-type type-${item.type}">
                                    ${typeEmoji[item.type]} ${typeLabel[item.type]}
                                </span>
                                <span class="urgency ${urgencyClass}">
                                    ${urgencyLabel[item.data.urgency] || 'متوسط'}
                                </span>
                                <span style="color: #6c757d; font-size: 12px;">${date}</span>
                            </div>
                            <div>
                                <span style="background: ${item.status === 'new' ? '#28a745' : item.status === 'read' ? '#ffc107' : '#6c757d'}; color: white; padding: 4px 8px; border-radius: 10px; font-size: 11px;">
                                    ${item.status === 'new' ? 'جديد' : item.status === 'read' ? 'مقروء' : 'تم الرد'}
                                </span>
                            </div>
                        </div>
                        
                        <div class="feedback-content">
                            <div class="feedback-title">${item.data.subject || item.data.title || 'بدون عنوان'}</div>
                            <div class="feedback-text">${(item.data.message || item.data.description || item.data.reviewText || '').substring(0, 300)}${(item.data.message || item.data.description || item.data.reviewText || '').length > 300 ? '...' : ''}</div>
                            ${ratingDisplay}
                            ${item.data.userName ? `<div style="color: #6c757d; font-size: 14px; margin-top: 8px;">من: ${item.data.userName} (${item.data.userType || 'غير محدد'})</div>` : ''}
                        </div>
                        
                        <div class="feedback-actions">
                            <button class="action-btn" onclick="markAsRead('${item.id}')">👁️ تعيين كمقروء</button>
                            <button class="action-btn respond" onclick="respondToFeedback('${item.id}')">💬 رد</button>
                            <button class="action-btn respond" onclick="contactUser('${item.id}')">📱 تواصل</button>
                            <button class="action-btn delete" onclick="deleteFeedback('${item.id}')">🗑️ حذف</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function filterFeedback() {
            const typeFilter = document.getElementById('typeFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const urgencyFilter = document.getElementById('urgencyFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            filteredFeedback = allFeedback.filter(item => {
                if (typeFilter && item.type !== typeFilter) return false;
                if (statusFilter && item.status !== statusFilter) return false;
                if (urgencyFilter && item.data.urgency !== urgencyFilter) return false;
                if (dateFilter) {
                    const itemDate = new Date(item.timestamp).toDateString();
                    const filterDate = new Date(dateFilter).toDateString();
                    if (itemDate !== filterDate) return false;
                }
                return true;
            });
            
            displayFeedback();
        }
        
        function clearFilters() {
            document.getElementById('typeFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('urgencyFilter').value = '';
            document.getElementById('dateFilter').value = '';
            filteredFeedback = [...allFeedback];
            displayFeedback();
        }
        
        function markAsRead(id) {
            // Update status locally
            const item = allFeedback.find(f => f.id === id);
            if (item) {
                item.status = 'read';
                displayFeedback();
                
                // In real implementation, call API
                console.log('Marking as read:', id);
            }
        }
        
        function respondToFeedback(id) {
            const item = allFeedback.find(f => f.id === id);
            if (item) {
                const response = prompt(`رد على: ${item.data.subject || item.data.title || 'الرسالة'}`, '');
                if (response) {
                    item.status = 'responded';
                    item.response = response;
                    displayFeedback();
                    alert('تم حفظ الرد!');
                }
            }
        }
        
        function contactUser(id) {
            const item = allFeedback.find(f => f.id === id);
            if (item && item.data.userContact) {
                const contact = item.data.userContact;
                if (contact.includes('@')) {
                    window.open(`mailto:${contact}`);
                } else {
                    window.open(`tel:${contact}`);
                }
            } else {
                alert('لا توجد معلومات تواصل لهذا المستخدم');
            }
        }
        
        function deleteFeedback(id) {
            if (confirm('هل أنت متأكد من حذف هذا التعليق؟')) {
                allFeedback = allFeedback.filter(f => f.id !== id);
                filteredFeedback = filteredFeedback.filter(f => f.id !== id);
                displayFeedback();
            }
        }
        
        function refreshData() {
            document.getElementById('feedbackListContent').innerHTML = '<div class="loading"><div style="font-size: 24px; margin-bottom: 10px;">🔄</div>جاري تحديث البيانات...</div>';
            setTimeout(() => {
                loadFeedbackData();
            }, 1000);
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadFeedbackData();
        });
    </script>
</body>
</html>
